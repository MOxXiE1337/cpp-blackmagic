<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Override in .vcxproj if needed -->
    <CppbmPythonExe Condition="'$(CppbmPythonExe)'==''">python</CppbmPythonExe>
    <CppbmPythonArgs Condition="'$(CppbmPythonArgs)'==''"></CppbmPythonArgs>
    <CppbmScriptDir Condition="'$(CppbmScriptDir)'==''">$(MSBuildThisFileDirectory)..\</CppbmScriptDir>
    <CppbmDecoratorScript Condition="'$(CppbmDecoratorScript)'==''">$(CppbmScriptDir)decorator.py</CppbmDecoratorScript>
    <CppbmInjectScript Condition="'$(CppbmInjectScript)'==''">$(CppbmScriptDir)inject.py</CppbmInjectScript>
    <CppbmStrictArg Condition="'$(CppbmStrictArg)'==''">--strict-parser</CppbmStrictArg>
    <!-- VS fast up-to-date check may skip MSBuild and hide custom pipeline changes. -->
    <CppbmDisableFastUpToDateCheck Condition="'$(CppbmDisableFastUpToDateCheck)'==''">true</CppbmDisableFastUpToDateCheck>
    <DisableFastUpToDateCheck Condition="'$(CppbmDisableFastUpToDateCheck)'=='true'">true</DisableFastUpToDateCheck>
  </PropertyGroup>

  <Target Name="CppbmPreprocess"
          BeforeTargets="ClCompile">
    <Error Condition="!Exists('$(CppbmDecoratorScript)')" Text="[cpp-blackmagic] decorator.py not found: $(CppbmDecoratorScript)" />
    <Error Condition="!Exists('$(CppbmInjectScript)')" Text="[cpp-blackmagic] inject.py not found: $(CppbmInjectScript)" />

    <!-- Build-scoped input selection: keep only C/C++ sources and exclude generated files. -->
    <ItemGroup>
      <CppbmInput Include="@(ClCompile)" />
      <CppbmInput Remove="**\*.cppbm.decor.cpp;**\*.cppbm.gen.cpp" />
    </ItemGroup>

    <MakeDir Directories="@(CppbmInput->'$(IntDir)cppbm\%(RelativeDir)')" />

    <!-- Pass 1: decorator.py -->
    <Exec Command="&quot;$(CppbmPythonExe)&quot; $(CppbmPythonArgs) &quot;$(CppbmDecoratorScript)&quot; --in &quot;%(CppbmInput.FullPath)&quot; --out &quot;$(IntDir)cppbm\%(CppbmInput.RelativeDir)%(CppbmInput.Filename).cppbm.decor.cpp&quot; $(CppbmStrictArg)"
          StandardOutputImportance="Normal"
          StandardErrorImportance="High" />

    <!-- Pass 2: inject.py -->
    <Exec Command="&quot;$(CppbmPythonExe)&quot; $(CppbmPythonArgs) &quot;$(CppbmInjectScript)&quot; --in &quot;$(IntDir)cppbm\%(CppbmInput.RelativeDir)%(CppbmInput.Filename).cppbm.decor.cpp&quot; --out &quot;$(IntDir)cppbm\%(CppbmInput.RelativeDir)%(CppbmInput.Filename).cppbm.gen.cpp&quot; $(CppbmStrictArg)"
          StandardOutputImportance="Normal"
          StandardErrorImportance="High" />
  </Target>

  <!-- Must run even when preprocess target is up-to-date, so compile inputs are consistently swapped. -->
  <Target Name="CppbmSwapCompileInputs" BeforeTargets="ClCompile" DependsOnTargets="CppbmPreprocess">
    <ItemGroup>
      <CppbmInput Include="@(ClCompile)" />
      <CppbmInput Remove="**\*.cppbm.decor.cpp;**\*.cppbm.gen.cpp" />
      <ClCompile Remove="@(CppbmInput)" />
      <ClCompile Include="@(CppbmInput->'$(IntDir)cppbm\%(RelativeDir)%(Filename).cppbm.gen.cpp')">
        <CppbmGenerated>true</CppbmGenerated>
      </ClCompile>
    </ItemGroup>
  </Target>

</Project>
